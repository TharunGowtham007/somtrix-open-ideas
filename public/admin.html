<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>SOMTRIX™™™™ Admin â€” Ideas</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body{font-family:system-ui,-apple-system,BlinkMacSystemFont,"Inter",sans-serif;margin:0;background:#f6f8fb;color:#111}
    .wrap{max-width:1100px;margin:18px auto;padding:18px}
    header{display:flex;justify-content:space-between;align-items:center;gap:12px}
    .btn{padding:8px 14px;border-radius:8px;border:none;cursor:pointer}
    .input{padding:8px;border-radius:8px;border:1px solid #d6dbe6}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{padding:10px;border-bottom:1px solid #e6e9f0;text-align:left;font-size:13px}
    .danger{background:#ff6b6b;color:#fff}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h2>SOMTRIX™™™™ â€” Admin dashboard</h2>
        <div style="color:#666;font-size:13px">Only you should access this. Keep your admin key secret.</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <input id="adminKeyInput" class="input" placeholder="Enter admin key" style="min-width:260px">
        <button id="btnLogin" class="btn">Login</button>
        <button id="btnLogout" class="btn" style="display:none">Logout</button>
      </div>
    </header>

    <section style="margin-top:14px;display:flex;gap:8px;align-items:center">
      <input id="q" class="input" placeholder="Search title or author" style="flex:1">
      <select id="adminCategoryFilter" class="input">
        <option value="">All categories</option>
        <option>Apparel / Clothes</option><option>Kitchen</option><option>Home</option><option>Electronics</option>
        <option>Health &amp; Wellness</option><option>Transport</option><option>Education</option><option>Energy</option>
        <option>Food &amp; Beverage</option><option>Sports</option><option>Toys &amp; Games</option><option>Office</option>
        <option>Gardening</option><option>Construction</option><option>Beauty &amp; Personal Care</option><option>Pet Care</option>
        <option>Finance</option><option>Software</option><option>Services</option><option>Other</option>
      </select>
      <button id="btnRefresh" class="btn">Refresh</button>
      <button id="btnExport" class="btn">Export JSON</button>
    </section>

    <div id="status" style="margin-top:10px;color:#444"></div>

    <table id="ideasTable" style="display:none">
      <thead><tr><th>ID</th><th>Title</th><th>Category</th><th>Author</th><th>Email</th><th>Votes</th><th>Created</th><th>Actions</th></tr></thead>
      <tbody id="ideasBody"></tbody>
    </table>
  </div>

  <script>
    const API_BASE = '';
    const adminKeyStorage = 'SOMTRIX™™™™_admin_key';

    function setStatus(msg, err) {
      const s = document.getElementById('status');
      s.textContent = msg || '';
      s.style.color = err ? '#900' : '#444';
    }

    function saveKey(k) { sessionStorage.setItem(adminKeyStorage, k); }
    function loadKey() { return sessionStorage.getItem(adminKeyStorage) || ''; }
    function clearKey() { sessionStorage.removeItem(adminKeyStorage); }

    async function fetchIdeas() {
      const key = loadKey();
      if (!key) { setStatus('Not authenticated'); return; }
      setStatus('Loading ideas...');
      const cat = document.getElementById('adminCategoryFilter').value || '';
      let url = '/api/admin/ideas';
      if (cat) url += '?category=' + encodeURIComponent(cat);
      try {
        const res = await fetch(url, { headers: { 'x-admin-key': key }});
        if (!res.ok) {
          if (res.status === 403) { setStatus('Admin access denied â€” check key', true); return; }
          throw new Error('Failed to fetch');
        }
        const rows = await res.json();
        renderTable(rows);
        setStatus('Loaded ' + rows.length + ' ideas');
      } catch (err) {
        console.error(err);
        setStatus('Failed to load ideas: ' + (err.message||''), true);
      }
    }

    function renderTable(rows) {
      const table = document.getElementById('ideasTable');
      const body = document.getElementById('ideasBody');
      body.innerHTML = '';
      rows.forEach(r => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${r.id}</td>
          <td style="max-width:260px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${escapeHtml(r.title)}</td>
          <td>${escapeHtml(r.category||'')}</td>
          <td>${escapeHtml(r.author||'Anonymous')}</td>
          <td>${escapeHtml(r.email||'')}</td>
          <td style="font-weight:600">${r.votes||0}</td>
          <td>${r.created_at||''}</td>
          <td>
            <button data-id="${r.id}" class="btn view">View</button>
            <button data-id="${r.id}" class="btn danger delete">Delete</button>
          </td>
        `;
        body.appendChild(tr);
      });
      table.style.display = rows.length ? '' : 'none';

      // wire buttons
      document.querySelectorAll('button.view').forEach(b=>{
        b.addEventListener('click', ()=> {
          const id = b.getAttribute('data-id');
          window.open('/vote.html', '_blank'); // quick
          setStatus('Use vote page to inspect ID #' + id);
        });
      });
      document.querySelectorAll('button.delete').forEach(b=>{
        b.addEventListener('click', ()=> confirmDelete(Number(b.getAttribute('data-id'))));
      });
    }

    function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

    async function confirmDelete(id) {
      if (!confirm('Delete idea ID #' + id + ' ? This is permanent.')) return;
      const key = loadKey();
      if (!key) return setStatus('Not authenticated', true);
      try {
        const res = await fetch('/api/admin/ideas/' + id + '?admin_key=' + encodeURIComponent(key), { method: 'DELETE' });
        if (!res.ok) {
          const d = await res.json().catch(()=>({}));
          throw new Error(d.error || 'Delete failed');
        }
        setStatus('Deleted ID #' + id);
        fetchIdeas();
      } catch (err) {
        console.error(err);
        setStatus('Delete failed: ' + (err.message||''), true);
      }
    }

    document.getElementById('btnLogin').addEventListener('click', ()=> {
      const k = document.getElementById('adminKeyInput').value.trim();
      if (!k) return alert('Enter admin key');
      saveKey(k);
      document.getElementById('btnLogin').style.display='none';
      document.getElementById('btnLogout').style.display='';
      document.getElementById('adminKeyInput').value = '';
      fetchIdeas();
    });

    document.getElementById('btnLogout').addEventListener('click', ()=> {
      clearKey();
      document.getElementById('btnLogin').style.display='';
      document.getElementById('btnLogout').style.display='none';
      setStatus('Logged out');
      document.getElementById('ideasBody').innerHTML='';
      document.getElementById('ideasTable').style.display='none';
    });

    document.getElementById('btnRefresh').addEventListener('click', fetchIdeas);
    document.getElementById('btnExport').addEventListener('click', ()=> {
      const k = loadKey();
      if (!k) return alert('Login first');
      // trigger download
      window.location = '/api/admin/export?admin_key=' + encodeURIComponent(k);
    });

    // quick: try session key
    (function init() {
      const k = loadKey();
      if (k) {
        document.getElementById('btnLogin').style.display='none';
        document.getElementById('btnLogout').style.display='';
        setStatus('Authenticated (session)');
        fetchIdeas();
      }
    })();
  </script>
</body>
</html>




