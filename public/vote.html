<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>SOMTRIX&trade; — Vote on Ideas</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <style>
    :root{
      --bg-top:#eef2fb; --accent:#7F8CBD; --muted:#6c7689; --card:#fff; --radius:16px;
      --maxw:1100px; font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial;
    }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(145deg,var(--bg-top),#f4f7fb);color:#111}
    .wrap{max-width:var(--maxw);margin:16px auto;padding:16px}
    header{display:flex;align-items:center;gap:12px}
    .logo{width:60px;height:60px;border-radius:50%;background:#fff;display:flex;align-items:center;justify-content:center}
    nav{margin-left:auto;display:flex;gap:12px}
    .card{background:var(--card);padding:14px;border-radius:18px;border:1px solid rgba(200,210,230,0.7);box-shadow:0 12px 30px rgba(0,0,0,0.05)}
    .toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:12px}
    input.search{padding:8px 10px;border-radius:999px;border:1px solid #d8dfef;width:220px}
    select{padding:8px;border-radius:999px;border:1px solid #d8dfef}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px}
    .idea{background:#fbfdff;border-radius:12px;padding:10px;border:1px solid rgba(220,230,245,0.9);display:flex;flex-direction:column;min-height:220px}
    .banner{height:76px;border-radius:10px;background:linear-gradient(140deg,#7f8cbd,#34495e);margin-bottom:8px;display:flex;align-items:flex-end;padding:8px;color:#fff}
    .title{font-weight:700;margin:4px 0}
    .problem{color:var(--muted);font-size:13px;line-height:1.35;overflow:hidden;max-height:72px}
    .footer{margin-top:auto;display:flex;justify-content:space-between;align-items:center}
    .btn{padding:6px 10px;border-radius:999px;background:var(--accent);color:#fff;border:none;cursor:pointer}
    @media(max-width:720px){.wrap{padding:12px} .toolbar{flex-direction:column;align-items:flex-start}}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo"><img src="logo.png" alt="SOMTRIX" style="width:44px"></div>
      <div>
        <div style="font-weight:800">SOMTRIX&trade;</div>
        <div style="color:var(--muted)">Browse & vote ideas</div>
      </div>
      <nav>
        <a href="index.html" style="color:var(--muted);text-decoration:underline">Home</a>
        <a href="publish.html" style="color:var(--muted);text-decoration:underline">Publish</a>
        <a href="products.html" style="color:var(--muted);text-decoration:underline">Products</a>
      </nav>
    </header>

    <main class="card" style="margin-top:12px">
      <div class="toolbar">
        <input id="search" class="search" placeholder="Search by title or author...">
        <select id="sort">
          <option value="top">Top supported</option>
          <option value="new">Newest first</option>
        </select>
        <div style="margin-left:auto;color:var(--muted)" id="idea-count">Loading...</div>
      </div>

      <div id="list" class="grid" aria-live="polite"></div>
    </main>
  </div>

  <script>
    const API = '';
    let ideas = [];

    function getBrowserToken(){
      try{
        let t = localStorage.getItem('somtrix_browser_token');
        if(!t){
          if(window.crypto && crypto.randomUUID) t = crypto.randomUUID();
          else t = Date.now().toString(36) + '-' + Math.random().toString(16).slice(2);
          localStorage.setItem('somtrix_browser_token', t);
        }
        return t;
      }catch(e){ return '' }
    }
    function getVotedIds(){ try{ const r=localStorage.getItem('somtrix_voted_ids'); return r?JSON.parse(r):[] }catch(e){return[]} }
    function saveVotedIds(ids){ try{ localStorage.setItem('somtrix_voted_ids', JSON.stringify(ids)) }catch(e){} }

    function formatAge(ts){
      const t = Date.parse(ts);
      if(isNaN(t)) return '';
      const diff = Date.now()-t; const m = Math.floor(diff/60000);
      if(m<1) return 'Just now'; if(m<60) return m+' min';
      const h = Math.floor(m/60); if(h<24) return h+' h'; const d=Math.floor(h/24);
      if(d<7) return d+' d'; return Math.floor(d/7)+' w';
    }

    function render(){
      const q = (document.getElementById('search').value || '').trim().toLowerCase();
      const sort = document.getElementById('sort').value || 'top';
      let arr = ideas.filter(i => !q || (i.title||'').toLowerCase().includes(q) || (i.author||'').toLowerCase().includes(q));
      if(sort === 'new') arr.sort((a,b)=> new Date(b.created_at)-new Date(a.created_at));
      else arr.sort((a,b) => (b.votes||0)-(a.votes||0) || (new Date(b.created_at)-new Date(a.created_at)));
      const list = document.getElementById('list'); list.innerHTML = '';
      if(arr.length===0){ document.getElementById('idea-count').textContent = 'No ideas'; list.innerHTML = '<div style="grid-column:1/-1;color:var(--muted)">No ideas yet.</div>'; return; }
      document.getElementById('idea-count').textContent = arr.length + ' ideas';
      const voted = getVotedIds();
      arr.forEach(i => {
        const el = document.createElement('article'); el.className='idea';
        const banner = document.createElement('div'); banner.className='banner'; banner.textContent='Idea';
        const title = document.createElement('div'); title.className='title'; title.textContent = i.title;
        const author = document.createElement('div'); author.style.fontSize='12px'; author.style.color='var(--muted)'; author.textContent = 'By ' + ((i.author||'').trim() || 'Anonymous') + ' · ' + formatAge(i.created_at);
        const prob = document.createElement('div'); prob.className='problem'; prob.textContent = i.problem;
        const footer = document.createElement('div'); footer.className='footer';
        const left = document.createElement('div');
        const btn = document.createElement('button'); btn.className='btn'; btn.textContent='Support ❤';
        if(voted.includes(i.id)) { btn.disabled=true; btn.style.opacity=0.6; }
        btn.addEventListener('click', ()=> vote(i.id, btn));
        const votes = document.createElement('div'); votes.style.fontWeight='700'; votes.style.marginLeft='8px'; votes.textContent = (i.votes||0) + ' supports';
        left.appendChild(btn); left.appendChild(votes);
        footer.appendChild(left);
        el.appendChild(banner);
        el.appendChild(title);
        el.appendChild(author);
        el.appendChild(prob);
        el.appendChild(footer);
        list.appendChild(el);
      });
    }

    async function load(){
      try{
        const params = new URLSearchParams();
        const q = (document.getElementById('search').value || '').trim();
        const s = document.getElementById('sort').value || 'top';
        if(s) params.append('sort', s);
        if(q) params.append('search', q);
        const res = await fetch(API + '/api/ideas?' + params.toString());
        if(!res.ok) throw new Error('Failed');
        ideas = await res.json();
        render();
      }catch(e){
        document.getElementById('list').innerHTML = '<div style="grid-column:1/-1;color:#b00">Unable to load ideas</div>';
        console.error(e);
      }
    }

    async function vote(id, btn){
      const voted = getVotedIds();
      if(voted.includes(id)){ alert('Already supported from this browser'); return; }
      try{
        btn.disabled = true;
        const res = await fetch(API + '/api/ideas/' + id + '/vote', {
          method: 'POST',
          headers: {'Content-Type':'application/json','x-voter-token': getBrowserToken()}
        });
        const data = await res.json();
        if(!res.ok){ throw new Error(data.error || 'Vote failed'); }
        if(data.alreadyVoted){
          voted.push(id); saveVotedIds(voted); render(); return;
        }
        // update local list
        ideas = ideas.map(i => i.id === data.id ? data : i);
        voted.push(id); saveVotedIds(voted);
        render();
      }catch(err){
        console.error(err);
        alert('Unable to register support now.');
        btn.disabled = false;
      }
    }

    document.getElementById('search').addEventListener('input', () => { load(); });
    document.getElementById('sort').addEventListener('change', load);
    document.addEventListener('DOMContentLoaded', load);
  </script>
</body>
</html>
