<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>SOMTRIX™ — Product</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{--bg:#eef2fb;--card:#fff;--muted:#6c7689;--accent:#7F8CBD}
    body{margin:0;background:linear-gradient(145deg,#eef2fb,#dfe7ff);font-family:system-ui,Segoe UI,Roboto,Arial;color:#111}
    .wrap{max-width:980px;margin:28px auto;padding:14px}
    header{display:flex;align-items:center;gap:12px;margin-bottom:14px}
    .logo{width:64px;height:64px;border-radius:50%;background:#fff;display:flex;align-items:center;justify-content:center}
    nav a{margin-left:14px;color:#6b78a6;text-decoration:underline}
    .hero{display:flex;gap:16px;align-items:flex-start}
    .gallery{width:320px;border-radius:12px;overflow:hidden;background:#fafbff;border:1px solid rgba(200,210,230,0.6)}
    .gallery img{width:100%;height:260px;object-fit:cover}
    .detail{flex:1}
    .update{background:var(--card);padding:12px;border-radius:10px;margin-top:10px;border:1px solid rgba(200,210,230,0.6)}
    .comment-form textarea{width:100%;min-height:80px;padding:8px;border-radius:8px;border:1px solid #d8dfef}
    .btn{display:inline-block;padding:8px 12px;border-radius:999px;background:var(--accent);color:#fff;text-decoration:none}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo"><img src="logo.png" style="width:50px;height:50px"></div>
      <div>
        <div style="font-weight:800">SOMTRIX™</div>
        <div style="color:var(--muted);font-size:13px">Product details & updates</div>
      </div>
      <nav style="margin-left:auto">
        <a href="products.html">Products</a>
        <a href="publish.html">Publish idea</a>
        <a href="vote.html">Vote ideas</a>
      </nav>
    </header>

    <main id="main">
      <div id="loading">Loading product...</div>
    </main>
  </div>

<script>
  function q(s){return new URLSearchParams(location.search).get(s)}
  const id = q('id');
  if(!id){
    document.getElementById('main').innerHTML = '<div style="color:#b00">Product id missing</div>';
  } else {
    fetch(`/api/products/${id}`).then(r=>r.json()).then(product=>{
      if(product.error) throw new Error(product.error || 'Not found');
      render(product);
    }).catch(e=>{
      document.getElementById('main').innerHTML = `<div style="color:#b00">Unable to load: ${e.message}</div>`;
    });
  }

  function render(p){
    const m = document.getElementById('main');
    const galleryHtml = (p.images && p.images.length) ? `<div class="gallery"><img src="${p.images[0]}" alt=""></div>` : `<div class="gallery" style="display:flex;align-items:center;justify-content:center;color:#7f8cbd">No image</div>`;
    let html = `<div class="hero">${galleryHtml}<div class="detail"><h1>${p.name}</h1><div style="color:#6c7689">${p.short_desc||''}</div><div style="margin-top:10px">${p.long_desc||''}</div><div style="margin-top:12px;color:var(--muted)">Status: ${p.status||'—'} • Release: ${p.release_date||'—'} • Price: ${p.price||'—'}</div></div></div>`;
    html += '<section style="margin-top:18px"><h3>Updates</h3>';
    if(p.updates && p.updates.length){
      p.updates.forEach(u=>{
        html += `<div class="update"><div style="font-weight:700">${u.title||'Update'}</div><div style="color:var(--muted);font-size:12px">${u.created_at}</div><div style="margin-top:8px">${u.body||''}</div>`;
        if(u.images && u.images.length){
          html += '<div style="display:flex;gap:8px;margin-top:8px">';
          u.images.forEach(img => html += `<img src="${img}" style="width:120px;height:80px;object-fit:cover;border-radius:6px">`);
          html += '</div>';
        }
        html += '</div>';
      });
    } else {
      html += '<div style="color:var(--muted)">No updates yet.</div>';
    }
    html += '</section>';

    // comments
    html += `<section style="margin-top:18px"><h3>Comments</h3><div id="comments"></div><div style="margin-top:8px"><form id="comment-form"><input id="author" placeholder="Your name (optional)" style="width:100%;padding:8px;border-radius:8px;border:1px solid #d8dfef"><div style="height:8px"></div><textarea id="content" placeholder="Share your thoughts" style="width:100%;padding:8px;border-radius:8px;border:1px solid #d8dfef"></textarea><div style="height:8px"></div><button class="btn" type="submit">Post comment</button></form></div></section>`;

    m.innerHTML = html;

    const commentsContainer = document.getElementById('comments');
    if(p.comments && p.comments.length){
      p.comments.forEach(c => {
        const el = document.createElement('div');
        el.style.borderTop = '1px solid rgba(200,210,230,0.6)';
        el.style.padding = '8px 0';
        el.innerHTML = `<div style="font-weight:600">${c.author||'Anonymous'} <span style="color:var(--muted);font-size:12px">• ${c.created_at}</span></div><div style="margin-top:6px">${c.content}</div>`;
        commentsContainer.appendChild(el);
      });
    } else {
      commentsContainer.innerHTML = '<div style="color:var(--muted)">No comments yet.</div>';
    }

    // comment submit
    document.getElementById('comment-form').addEventListener('submit', async (ev) => {
      ev.preventDefault();
      const author = document.getElementById('author').value;
      const content = document.getElementById('content').value;
      if(!content || !content.trim()){ alert('Write a comment'); return; }
      try{
        const res = await fetch(`/api/products/${p.id}/comments`, {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ author, content })
        });
        if(!res.ok) throw new Error('Failed to submit');
        const c = await res.json();
        // prepend comment
        const el = document.createElement('div');
        el.style.borderTop = '1px solid rgba(200,210,230,0.6)';
        el.style.padding = '8px 0';
        el.innerHTML = `<div style="font-weight:600">${c.author||'Anonymous'} <span style="color:var(--muted);font-size:12px">• ${c.created_at}</span></div><div style="margin-top:6px">${c.content}</div>`;
        commentsContainer.insertBefore(el, commentsContainer.firstChild);
        document.getElementById('content').value = '';
        document.getElementById('author').value = '';
      }catch(err){ alert('Unable to post comment'); console.error(err); }
    });
  }
</script>
</body>
</html>
